<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Report Raider</title>
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      :root {
        --text: #ece2d0;
        --muted: rgba(236, 226, 208, 0.7);
        --card: #130918;
        --border: rgba(236, 226, 208, 0.2);
        --error: #d9534f;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        position: relative;
        color: var(--text);
        background-color: #130918;
      }

      .page-bg {
        position: fixed;
        inset: 0;
        height: 100vh;
        background-image: linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.45),
            rgba(19, 9, 24, 0.9)
          ),
          url("./assets/backgrounds/RaidersWatchBackground.jpg");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        z-index: 0;
        pointer-events: none;
      }

      main {
        position: relative;
        z-index: 1;
        max-width: 900px;
        margin: 0 auto;
        padding: 32px 24px 48px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
      }

      h1 {
        margin: 0 0 8px;
      }

      .subtitle {
        margin: 0 0 16px;
        color: var(--muted);
      }

      form {
        display: grid;
        gap: 12px;
      }

      .alert {
        border: 1px solid var(--error);
        background: rgba(217, 83, 79, 0.12);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 10px;
        display: none;
        margin-bottom: 8px;
      }

      .alert.success {
        border-color: #2ecc71;
        background: rgba(46, 204, 113, 0.12);
      }

      label {
        font-weight: 600;
        margin-bottom: 4px;
      }

      input[type="text"],
      select,
      input[type="file"] {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.04);
        color: var(--text);
      }

      input[type="text"]::placeholder {
        color: var(--muted);
      }

      button {
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid rgba(236, 226, 208, 0.35);
        background: var(--text);
        color: #130918;
        font-weight: 700;
        cursor: pointer;
      }

      button:hover {
        background: #fff4df;
      }

      .field {
        display: flex;
        flex-direction: column;
      }
    </style>
  </head>
  <body>
    <div class="page-bg" aria-hidden="true"></div>
    <main>
      <div class="card">
        <h1>Report Raider</h1>
        <p class="subtitle">Flag a raider by Embark ID and include any evidence.</p>
        <div id="form-alert" class="alert"></div>
        <form id="report-form">
          <div class="field">
            <label for="embark-id">Raider's Embark ID</label>
            <input
              id="embark-id"
              name="embark-id"
              type="text"
              required
              placeholder="Enter raider's Embark ID"
              pattern="^[A-Za-z0-9_-]+#\\d{4}$"
              title="Use the format username#1234"
            />
          </div>

          <div class="field">
            <label for="reason">Reason for Report</label>
            <select id="reason" name="reason" required>
              <option value="">Select a reason</option>
              <option value="betrayal">Betrayal</option>
              <option value="rat-tactics">Rat Tactics</option>
              <option value="afk-griefing">AFK / Griefing</option>
              <option value="verbal-abuse">Verbal Abuse / Hate Speech</option>
              <option value="cheating-exploiting">Cheating / Exploiting</option>
              <option value="offensive-name">Offensive or Innaproriate Name</option>
            </select>
          </div>

          <div class="field">
            <label for="comments">Comments (Optional)</label>
            <input id="comments" name="comments" type="text" />
          </div>

          <div class="field">
            <label for="evidence">Media (Optional)</label>
            <input
              id="evidence"
              name="evidence"
              type="file"
              multiple
              accept="image/png,image/jpeg,image/gif,video/mp4,video/quicktime,video/webm,video/x-msvideo,video/x-matroska"
            />
          </div>

          <button type="submit">Submit Report</button>
        </form>
      </div>
    </main>
    <script>
      function validateTag(value) {
        return /^[A-Za-z0-9_-]+#\d{4}$/.test(value);
      }

      const form = document.getElementById("report-form");
      const embarkInput = document.getElementById("embark-id");
      const reasonSelect = document.getElementById("reason");
      const commentsInput = document.getElementById("comments");
      const evidenceInput = document.getElementById("evidence");
      const sessionIdKey = "rw-session-id";
      const words = [
        "Wasp",
        "Hornet",
        "Snitch",
        "Tick",
        "Pop",
        "Fireball",
        "Surveyor",
        "Rollbot",
        "Leaper",
        "Bastion",
        "Bombardier",
        "Sentinel",
      ];

      function getSessionId() {
        const existing = localStorage.getItem(sessionIdKey);
        if (existing) return existing;
        let candidate = "";
        let attempts = 0;
        while (!candidate && attempts < 20) {
          const word = words[Math.floor(Math.random() * words.length)];
          const suffix = String(Math.floor(10000 + Math.random() * 90000));
          candidate = `${word}-${suffix}`;
          attempts++;
        }
        const finalId = candidate || `Wasp-${Date.now() % 100000}`;
        localStorage.setItem(sessionIdKey, finalId);
        return finalId;
      }
      const sessionId = getSessionId();
      const formAlert = document.getElementById("form-alert");

      function showAlert(message, type = "error") {
        if (!formAlert) return;
        formAlert.textContent = message;
        formAlert.classList.toggle("success", type === "success");
        formAlert.style.display = "block";
      }

      function clearAlert() {
        if (!formAlert) return;
        formAlert.textContent = "";
        formAlert.style.display = "none";
        formAlert.classList.remove("success");
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        clearAlert();
        const tag = embarkInput.value.trim();
        const reason = reasonSelect.value;
        const comments = commentsInput.value.trim();
        const evidenceFiles = Array.from(evidenceInput.files || []);

        if (!validateTag(tag)) {
          showAlert("Invalid Embark ID.");
          return;
        }

        if (!reason) {
          showAlert("Select a reason for the report.");
          return;
        }

        try {
          const formData = new FormData();
          formData.append("tag", tag);
          formData.append("reason", reason);
          formData.append("comments", comments);
          formData.append("reporter_label", sessionId);
          if (evidenceFiles.length) {
            evidenceFiles.forEach((file) => {
              formData.append("evidence", file);
            });
          }

          const response = await fetch("/api/report", {
            method: "POST",
            body: formData,
          });

          const result = await response.json().catch(() => ({}));

          if (!response.ok) {
            showAlert(result.error || "Failed to submit report.");
            return;
          }

          showAlert("Report submitted. Returning to Sparanza...", "success");
          form.reset();
          setTimeout(() => {
            window.location.href = "/";
          }, 3000);
        } catch (error) {
          showAlert("Network error submitting report.");
        }
      });
    </script>
  </body>
</html>
